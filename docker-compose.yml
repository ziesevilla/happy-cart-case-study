version: '3.8'
services:

  # 1. Laravel Application Service (PHP-FPM)
  app:
    build:
      context: ./backend      # Use the custom Dockerfile in the backend folder
      dockerfile: Dockerfile
    image: laravel-app-image
    restart: unless-stopped
    volumes:
      - ./backend:/var/www/html # Mounts your local Laravel code
    networks:
      - app-network

  # 2. Web Server Service (Nginx)
  nginx:
    image: nginx:stable-alpine
    restart: unless-stopped
    ports:
      - "80:80"             # Access Laravel API at http://localhost
    volumes:
      - ./backend:/var/www/html
      # Nginx config to route API calls to 'app' and serve React build (if built)
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    networks:
      - app-network
    depends_on:
      - app
      - frontend # Ensure the React service is available for proxying

  # 3. MySQL Database Service
  mysql:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      # These variables pull from your root .env file (or use defaults)
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-secret}
      MYSQL_DATABASE: ${DB_DATABASE:-happy_cart_db}
      MYSQL_USER: ${DB_USERNAME:-user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-secret}
    volumes:
      - dbdata:/var/lib/mysql # Persist your database data
    networks:
      - app-network

  # 4. phpMyAdmin Service
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    restart: always
    ports:
      - "8080:80"             # Access phpMyAdmin at http://localhost:8080
    environment:
      PMA_HOST: mysql         # Connects to the 'mysql' service name
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-secret}
    networks:
      - app-network
    depends_on:
      - mysql

  # 5. React Frontend Development Server
  frontend:
    image: node:18-alpine     # Use a standard Node image (no custom Dockerfile needed)
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./frontend:/app       # Mount the React code for hot reloading
      - /app/node_modules     # Exclude the node_modules to use the one installed inside the container
    ports:
      - "3000:3000"           # Access React app at http://localhost:3000
    command: npm run dev      # Assumes your React app uses 'npm run dev' to start
    networks:
      - app-network

# Define volumes and networks
volumes:
  dbdata:
    driver: local

networks:
  app-network:
    driver: bridge